---
published: true
title: Govee Thermomètre/Hygromètre
tags: display temperature monitoring bluetooth hardware
---
> Petit Moniteur - [amazon](https://www.amazon.fr/gp/product/B08XQBZWHQ/ref=ppx_yo_dt_b_asin_title_o06_s00?ie=UTF8&th=1) / [github](https://github.com/wcbonner/GoveeBTTempLogger)

![caption](https://github.com/wcbonner/GoveeBTTempLogger/raw/master/gvh-E35ECC215C0F-day.svg)

## [Bluetooth scan]({% post_url 2022-09-17-linux-bluetooth %})

{% highlight text %}
[NEW] Device A4:C1:38:32:15:9E GVH5075_159E
[NEW] Device A4:C1:38:12:7D:CD GVH5075_7DCD
[NEW] Device A4:C1:38:E8:44:16 GVH5075_4416
{% endhighlight %}


### [Set scan parameters failed: Operation not permitted](https://unix.stackexchange.com/questions/96106/bluetooth-le-scan-as-non-root)

**LE Scan is working with bluetoothctl** - `bluetoothctl scan le`
But not with `sudo hcitool lescan`

You can observe HCI communication using `sudo btmon`
{% highlight text %}
@ RAW Open: hcitool (privileged) version 2.22                                              {0x0002} [hci0] 8.979713
< HCI Command: LE Set Scan Parameters (0x08|0x000b) plen 7                                       #1 [hci0] 8.979769
        Type: Active (0x01)
        Interval: 10.000 msec (0x0010)
        Window: 10.000 msec (0x0010)
        Own address type: Public (0x00)
        Filter policy: Accept all advertisement (0x00)
> HCI Event: Command Complete (0x0e) plen 4                                                      #2 [hci0] 9.096956
      LE Set Scan Parameters (0x08|0x000b) ncmd 1
        Status: Command Disallowed (0x0c)
@ RAW Close: hcitool                                                                       {0x0002} [hci0] 9.097866
{% endhighlight %}

The "Operation not permitted" error is generated by a writev system call, with the call stack locking as follows (all functions implemented in hci.c, see the bluez source code):

{% highlight text %}
hci_le_set_scan_parameters -> hci_send_req -> hci_send_cmd -> writev
{% endhighlight %}

This can be confirmed using `strace`

{% highlight text %}
$ strace /usr/local/bin/goveebttemplogger 
writev(3, [{iov_base="\1", iov_len=1}, {iov_base="\24\f\0", iov_len=3}], 2) = 4
...
writev(3, [{iov_base="\1", iov_len=1}, {iov_base="\v \7", iov_len=3}, {iov_base="\1\22\0\22\0\1\0", iov_len=7}], 3) = -1 EPERM (Operation not permitted)
...
exit_group(0)                           = ?
{% endhighlight %}


see [Set scan parameters failed: Input/output error](https://stackoverflow.com/questions/60668497/hcitool-lescan-set-scan-parameters-failed-input-output-error?noredirect=1) - but no answer
